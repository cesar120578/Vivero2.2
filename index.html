<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Viveros RDM 3.0 PRO</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    background:black;
    color:gold;
    font-family:Arial;
    text-align:center;
}

.logo{
    font-size:28px;
    font-weight:bold;
    margin-top:10px;
}

.section{
    width:90%;
    margin:25px auto;
    border:1px solid gold;
    border-radius:10px;
    padding:20px;
}

h2{
    cursor:pointer;
    border-bottom:1px solid gold;
    padding-bottom:8px;
}

.hidden{
    display:none;
}

input,select,button{
    padding:8px;
    margin:6px;
    border-radius:6px;
    border:none;
}

button{
    background:gold;
    color:black;
    font-weight:bold;
    cursor:pointer;
}

button:hover{
    background:#d4af37;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
    font-size:18px;
}

th,td{
    border:1px solid gold;
    padding:10px;
}

th{
    background:#111;
}

canvas{
    margin-top:20px;
}

#loginBox{
    margin-top:100px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
    <h2>Iniciar Sesi칩n</h2>
    <input id="usuarioInput" placeholder="Usuario">
    <input id="claveInput" type="password" placeholder="Contrase침a">
    <button onclick="login()">Ingresar</button>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">

<div class="logo">游 VIVEROS RDM 游</div>
<div>
Usuario activo: <span id="usuarioActivo"></span>
<button onclick="cerrarSesion()">Cerrar sesi칩n</button>
</div>

<!-- AGREGAR -->
<div class="section">
<h2 onclick="toggle('agregarDiv')">Agregar Planta</h2>
<div id="agregarDiv" class="hidden">
<input id="nombreNueva" placeholder="Nombre">
<input id="precioNueva" type="number" placeholder="Precio">
<input id="cantidadNueva" type="number" placeholder="Cantidad">
<button onclick="agregarPlanta()">Agregar</button>
</div>
</div>

<!-- REABASTECER -->
<div class="section">
<h2 onclick="toggle('reabastecerDiv')">Reabastecer Inventario</h2>
<div id="reabastecerDiv" class="hidden">
<select id="reabastecerNombre"></select>
<input id="reabastecerCantidad" type="number" placeholder="Cantidad">
<button onclick="reabastecer()">Reabastecer</button>
</div>
</div>

<!-- INVENTARIO -->
<div class="section">
<h2 onclick="toggle('inventarioDiv')">Inventario</h2>
<div id="inventarioDiv" class="hidden">
<table>
<thead>
<tr>
<th>Planta</th>
<th>Precio</th>
<th>Stock</th>
</tr>
</thead>
<tbody id="tablaInventario"></tbody>
</table>
</div>
</div>

<!-- VENTAS -->
<div class="section">
<h2 onclick="toggle('ventasDiv')">Registrar Venta</h2>
<div id="ventasDiv" class="hidden">
<select id="ventaNombre"></select>
<input id="ventaCantidad" type="number" placeholder="Cantidad">
<button onclick="registrarVenta()">Vender</button>
</div>
</div>

<!-- REPORTES -->
<div class="section">
<h2 onclick="toggle('reporteDiv')">Reportes / Dashboard</h2>
<div id="reporteDiv" class="hidden">

<h3 onclick="toggle('reporteDia')">游늰 Reporte del D칤a</h3>
<div id="reporteDia" class="hidden">
<h4>Total del D칤a: $<span id="totalDia">0</span></h4>
<canvas id="graficaDia"></canvas>
<table>
<thead>
<tr>
<th>Planta</th>
<th>Cantidad</th>
<th>Precio</th>
<th>Total</th>
<th>Fecha</th>
</tr>
</thead>
<tbody id="tablaDia"></tbody>
</table>
</div>

<h3 onclick="toggle('reporteSemana')">游늱 Reporte Semanal</h3>
<div id="reporteSemana" class="hidden">
<h4>Total Semana: $<span id="totalSemana">0</span></h4>
<canvas id="graficaSemana"></canvas>
<table>
<thead>
<tr>
<th>Planta</th>
<th>Cantidad</th>
<th>Total</th>
<th>Fecha</th>
</tr>
</thead>
<tbody id="tablaSemana"></tbody>
</table>
</div>

<h3 onclick="toggle('reporteGeneral')">游늵 Reporte General</h3>
<div id="reporteGeneral" class="hidden">
<h4>Total General: $<span id="totalGeneral">0</span></h4>
<canvas id="graficaVentas"></canvas>
<table>
<thead>
<tr>
<th>Planta</th>
<th>Cantidad</th>
<th>Precio</th>
<th>Total</th>
<th>Fecha</th>
</tr>
</thead>
<tbody id="tablaGeneral"></tbody>
</table>
</div>

</div>
</div>

<!-- ADMIN -->
<div class="section">
<h2 onclick="toggle('adminDiv')">游 Funciones de Admin</h2>
<div id="adminDiv" class="hidden">

<button onclick="restablecerSistema()">Restablecer Sistema</button>

<h3>Corte del D칤a</h3>
<button onclick="corteDelDia()">Realizar Corte del D칤a</button>

<h3>Editar / Eliminar Planta</h3>
<select id="editarNombre" onchange="cargarDatosEdicion()"></select>
<br>
<input id="editarNuevoNombre" placeholder="Nuevo nombre">
<input id="editarNuevoPrecio" type="number" placeholder="Nuevo precio">
<input id="editarNuevaCantidad" type="number" placeholder="Nueva cantidad">
<br>
<button onclick="guardarCambios()">Guardar Cambios</button>
<button onclick="eliminarPlanta()">Eliminar Planta</button>

<h3>Historial de Cambios de Inventario</h3>
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Usuario</th>
<th>Acci칩n</th>
<th>Detalle</th>
</tr>
</thead>
<tbody id="tablaHistorial"></tbody>
</table>

</div>
</div>

</div>

<script>

const admins=["C칠sar","Oswaldo","Hanalih","Sofia","Valeria"];
const empleados=["Emp1","Emp2","Emp3"];
const claveAdmin="ViverosRDM12";
const claveEmpleado="ViverosRDMempl";

let usuarioActual="";
let plantas=JSON.parse(localStorage.getItem("plantas"))||{};
let ventas=JSON.parse(localStorage.getItem("ventas"))||[];
let ventasDia=JSON.parse(localStorage.getItem("ventasDia"))||[];
let ventasHistorico=JSON.parse(localStorage.getItem("ventasHistorico"))||[];
let historial=JSON.parse(localStorage.getItem("historial"))||[];

let graficaDia;
let graficaSemana;
let graficaGeneral;

/* LOGIN */
function login(){
    let u=usuarioInput.value;
    let c=claveInput.value;

    if((admins.includes(u)&&c===claveAdmin)||(empleados.includes(u)&&c===claveEmpleado)){
        usuarioActual=u;
        loginBox.classList.add("hidden");
        sistema.classList.remove("hidden");
        usuarioActivo.innerText=usuarioActual;
        actualizarTodo();
    } else alert("Usuario o contrase침a incorrectos");
}

function cerrarSesion(){ location.reload(); }

function guardar(){
    localStorage.setItem("plantas",JSON.stringify(plantas));
    localStorage.setItem("ventas",JSON.stringify(ventas));
    localStorage.setItem("ventasDia",JSON.stringify(ventasDia));
    localStorage.setItem("ventasHistorico",JSON.stringify(ventasHistorico));
    localStorage.setItem("historial",JSON.stringify(historial));
}

function registrarHistorial(accion,detalle){
    historial.push({
        fecha:new Date().toLocaleString(),
        usuario:usuarioActual,
        accion,
        detalle
    });
    guardar();
}

function toggle(id){ document.getElementById(id).classList.toggle("hidden"); }
function ordenar(){ return Object.keys(plantas).sort((a,b)=>a.localeCompare(b)); }

function actualizarInventario(){
    tablaInventario.innerHTML="";
    ordenar().forEach(nombre=>{
        tablaInventario.innerHTML+=`
        <tr>
        <td>${nombre}</td>
        <td>$${plantas[nombre].precio}</td>
        <td>${plantas[nombre].inventario}</td>
        </tr>`;
    });
}

function actualizarSelect(){
    ["ventaNombre","reabastecerNombre","editarNombre"].forEach(id=>{
        let s=document.getElementById(id);
        s.innerHTML="";
        ordenar().forEach(nombre=>{
            s.innerHTML+=`<option value="${nombre}">${nombre}</option>`;
        });
    });
}

function actualizarHistorial(){
    tablaHistorial.innerHTML="";
    historial.forEach(h=>{
        tablaHistorial.innerHTML+=`
        <tr>
        <td>${h.fecha}</td>
        <td>${h.usuario}</td>
        <td>${h.accion}</td>
        <td>${h.detalle}</td>
        </tr>`;
    });
}

function agregarPlanta(){
    let n=nombreNueva.value.trim();
    let p=parseFloat(precioNueva.value);
    let c=parseInt(cantidadNueva.value);
    if(!n||!p||!c) return alert("Datos inv치lidos");
    if(plantas[n]) return alert("Ya existe");
    plantas[n]={precio:p,inventario:c};
    registrarHistorial("Agregar",`Se agreg칩 ${n} (${c})`);
    guardar(); actualizarTodo();
}

function reabastecer(){
    let n=reabastecerNombre.value;
    let c=parseInt(reabastecerCantidad.value);
    if(!c||c<=0) return alert("Cantidad inv치lida");
    plantas[n].inventario+=c;
    registrarHistorial("Reabastecer",`${n} +${c}`);
    guardar(); actualizarTodo();
}

function registrarVenta(){
    let n=ventaNombre.value;
    let c=parseInt(ventaCantidad.value);
    if(!c||c<=0||plantas[n].inventario<c) return alert("Error");

    plantas[n].inventario-=c;

    let ventaObj={
        nombre:n,
        cantidad:c,
        precio:plantas[n].precio,
        total:c*plantas[n].precio,
        fecha:new Date().toLocaleString(),
        usuario:usuarioActual
    };

    ventas.push(ventaObj);
    ventasDia.push(ventaObj);
    ventasHistorico.push(ventaObj);

    guardar(); actualizarTodo();
}

function corteDelDia(){
    if(ventasDia.length===0) return alert("No hay ventas hoy");
    registrarHistorial("Corte del D칤a","Cierre con "+ventasDia.length+" ventas");
    ventasDia=[];
    guardar();
    actualizarReportes();
    alert("Corte realizado correctamente");
}

function restablecerSistema(){
    let codigo=prompt("C칩digo:");
    if(codigo==="241412"){
        plantas={}; ventas=[]; ventasDia=[]; ventasHistorico=[];
        localStorage.clear();
        alert("Sistema reiniciado");
        location.reload();
    }
}

function actualizarReportes(){

/* D칈A */
let totalD=0;
tablaDia.innerHTML="";
let conteoDia={};
ventasDia.forEach(v=>{
    totalD+=v.total;
    tablaDia.innerHTML+=`
    <tr>
    <td>${v.nombre}</td>
    <td>${v.cantidad}</td>
    <td>$${v.precio}</td>
    <td>$${v.total}</td>
    <td>${v.fecha}</td>
    </tr>`;
    conteoDia[v.nombre]=(conteoDia[v.nombre]||0)+v.cantidad;
});
totalDia.innerText=totalD;

if(graficaDia) graficaDia.destroy();
graficaDia=new Chart(document.getElementById("graficaDia"),{
    type:"bar",
    data:{labels:Object.keys(conteoDia),
    datasets:[{label:"Ventas del D칤a",data:Object.values(conteoDia)}]}
});

/* SEMANA */
let totalS=0;
tablaSemana.innerHTML="";
let conteoSemana={};
let hoy=new Date();
ventasHistorico.forEach(v=>{
    let f=new Date(v.fecha);
    let dif=(hoy-f)/(1000*60*60*24);
    if(dif<=7){
        totalS+=v.total;
        tablaSemana.innerHTML+=`
        <tr>
        <td>${v.nombre}</td>
        <td>${v.cantidad}</td>
        <td>$${v.total}</td>
        <td>${v.fecha}</td>
        </tr>`;
        conteoSemana[v.nombre]=(conteoSemana[v.nombre]||0)+v.cantidad;
    }
});
totalSemana.innerText=totalS;

if(graficaSemana) graficaSemana.destroy();
graficaSemana=new Chart(document.getElementById("graficaSemana"),{
    type:"bar",
    data:{labels:Object.keys(conteoSemana),
    datasets:[{label:"Ventas de la Semana",data:Object.values(conteoSemana)}]}
});

/* GENERAL */
let totalG=0;
tablaGeneral.innerHTML="";
let conteoGeneral={};
ventasHistorico.forEach(v=>{
    totalG+=v.total;
    tablaGeneral.innerHTML+=`
    <tr>
    <td>${v.nombre}</td>
    <td>${v.cantidad}</td>
    <td>$${v.precio}</td>
    <td>$${v.total}</td>
    <td>${v.fecha}</td>
    </tr>`;
    conteoGeneral[v.nombre]=(conteoGeneral[v.nombre]||0)+v.cantidad;
});
totalGeneral.innerText=totalG;

if(graficaGeneral) graficaGeneral.destroy();
graficaGeneral=new Chart(document.getElementById("graficaVentas"),{
    type:"bar",
    data:{labels:Object.keys(conteoGeneral),
    datasets:[{label:"Ventas Totales",data:Object.values(conteoGeneral)}]}
});
}

function actualizarTodo(){
    actualizarInventario();
    actualizarSelect();
    actualizarReportes();
    actualizarHistorial();
}

</script>
</body>
</html>
