<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Viveros RDM - ADMIN 2.2 PRO</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    font-family: Arial;
    background:#000;
    color:#d4af37;
    text-align:center;
}

.logo{
    width:200px;
    margin-top:20px;
    filter: drop-shadow(0 0 8px #d4af37);
}

.container{
    background:#111;
    margin:20px auto;
    padding:20px;
    width:95%;
    max-width:1000px;
    border-radius:15px;
    box-shadow:0 0 20px rgba(212,175,55,0.3);
}

input, select, button{
    width:90%;
    padding:10px;
    margin:5px;
    border-radius:8px;
    border:1px solid #d4af37;
    background:#000;
    color:#d4af37;
}

button{
    background:#d4af37;
    color:black;
    font-weight:bold;
    cursor:pointer;
}

button:hover{
    background:#f0c75e;
}

.section{
    margin-top:20px;
    padding:15px;
    border:1px solid #d4af37;
    border-radius:10px;
}

.hidden{ display:none; }

#mensaje{
    padding:10px;
    margin-bottom:10px;
    border-radius:8px;
    display:none;
    font-weight:bold;
}

.exito{ background:#1e7a3b; color:white; }
.error{ background:#a83232; color:white; }

.alerta{ color:red; font-weight:bold; }

canvas{
    margin-top:20px;
    background:#111;
    border-radius:10px;
    padding:10px;
}
</style>
</head>

<body>

<img src="logo.jpg" class="logo">
<h2>ðŸŒ¿ Viveros RDM - ADMIN 2.2 PRO</h2>

<div class="container" id="loginDiv">
<h3>Login Administrador</h3>
<input type="text" id="usuario">
<input type="password" id="clave">
<button onclick="login()">Entrar</button>
<p id="errorLogin"></p>
</div>

<div class="container hidden" id="panel">

<p>Usuario: <span id="usuarioActivo"></span></p>
<button onclick="logout()">Cerrar sesiÃ³n</button>

<div id="mensaje"></div>

<!-- INVENTARIO -->
<div class="section">
<h3 onclick="toggle('inventarioPanel')">ðŸ“¦ GestiÃ³n de Inventario</h3>
<div id="inventarioPanel" class="hidden">

<h4>Agregar Planta</h4>
<input type="text" id="nombreNueva" placeholder="Nombre">
<input type="number" id="precioNueva" placeholder="Precio">
<input type="number" id="cantidadNueva" placeholder="Cantidad inicial">
<button onclick="agregarPlanta()">Agregar</button>

<hr>

<h4>Reabastecer</h4>
<select id="reabastecerNombre"></select>
<input type="number" id="cantidadReabastecer" placeholder="Cantidad">
<button onclick="reabastecer()">Reabastecer</button>

<hr>
<button onclick="mostrarInventario()">Actualizar Inventario</button>
<div id="inventario"></div>

</div>
</div>

<!-- VENTAS -->
<div class="section">
<h3 onclick="toggle('ventasPanel')">ðŸ’° Ventas</h3>
<div id="ventasPanel" class="hidden">

<select id="ventaNombre"></select>
<input type="number" id="ventaCantidad" placeholder="Cantidad">

<label>
<input type="checkbox" id="descuentoCheck"> Aplicar descuento
</label>

<div id="descuentoDiv" class="hidden">
<input type="password" id="claveAdminDescuento" placeholder="Clave admin">
<input type="number" id="precioEspecial" placeholder="Nuevo precio">
</div>

<button onclick="registrarVenta()">Registrar Venta</button>

</div>
</div>

<!-- REPORTES -->
<div class="section">
<h3 onclick="toggle('reportesPanel')">ðŸ“Š Reportes y Dashboard</h3>
<div id="reportesPanel" class="hidden">

<div id="resumen"></div>
<button onclick="generarGraficas()">Actualizar GrÃ¡ficas</button>

<canvas id="graficaDia"></canvas>
<canvas id="graficaPlantas"></canvas>

</div>
</div>

</div>

<script>

// ===== CONFIG =====
const admins=["CÃ©sar","Oswaldo","Hanalih","Sofia","Valeria"];
const claveAdmin="ViverosRDM12";

let usuarioActual=null;
let plantas=JSON.parse(localStorage.getItem("plantas"))||{};
let ventas=JSON.parse(localStorage.getItem("ventas"))||[];

// ===== UTILIDADES =====
function guardar(){
    localStorage.setItem("plantas",JSON.stringify(plantas));
    localStorage.setItem("ventas",JSON.stringify(ventas));
}

function mostrarMensaje(texto,tipo){
    mensaje.innerText=texto;
    mensaje.className=tipo;
    mensaje.style.display="block";
    setTimeout(()=>mensaje.style.display="none",3000);
}

function toggle(id){
    document.getElementById(id).classList.toggle("hidden");
}

function obtenerNombresOrdenados(){
    return Object.keys(plantas).sort((a,b)=>a.localeCompare(b));
}

// ===== LOGIN =====
function login(){
    if(!admins.includes(usuario.value)||clave.value!==claveAdmin){
        errorLogin.innerText="Credenciales incorrectas";
        return;
    }
    usuarioActual=usuario.value;
    loginDiv.classList.add("hidden");
    panel.classList.remove("hidden");
    usuarioActivo.innerText=usuarioActual;
    actualizarSelects();
    actualizarResumen();
}

function logout(){ location.reload(); }

// ===== ACTUALIZAR SELECTS ORDENADOS =====
function actualizarSelects(){
    let nombres=obtenerNombresOrdenados();

    ventaNombre.innerHTML="";
    reabastecerNombre.innerHTML="";

    nombres.forEach(nombre=>{
        ventaNombre.innerHTML+=`<option>${nombre}</option>`;
        reabastecerNombre.innerHTML+=`<option>${nombre}</option>`;
    });
}

// ===== AGREGAR PLANTA =====
function agregarPlanta(){

    let nombre=nombreNueva.value.trim();
    let precioInput=precioNueva.value;
    let cantidadInput=cantidadNueva.value;

    if(nombre===""){
        mostrarMensaje("Ingresa el nombre de la planta ðŸŒ¿","error");
        return;
    }

    if(precioInput===""){
        mostrarMensaje("Ingresa el precio de la planta ðŸ’²","error");
        return;
    }

    if(cantidadInput===""){
        mostrarMensaje("Ingresa la cantidad de plantas ðŸ“¦","error");
        return;
    }

    let precio=parseFloat(precioInput);
    let cantidad=parseInt(cantidadInput);

    if(isNaN(precio)||precio<=0){
        mostrarMensaje("El precio debe ser mayor a 0 ðŸ’²","error");
        return;
    }

    if(isNaN(cantidad)||cantidad<0){
        mostrarMensaje("La cantidad no puede ser negativa ðŸ“¦","error");
        return;
    }

    if(plantas[nombre]){
        mostrarMensaje("Esa planta ya existe","error");
        return;
    }

    plantas[nombre]={precio,inventario:cantidad,vendidas:0};

    guardar();
    actualizarSelects();

    nombreNueva.value="";
    precioNueva.value="";
    cantidadNueva.value="";

    mostrarMensaje("Planta agregada correctamente ðŸŒ¿","exito");
}

// ===== REABASTECER =====
function reabastecer(){

    let nombre=reabastecerNombre.value;
    let cantidadInput=cantidadReabastecer.value;

    if(nombre===""){
        mostrarMensaje("Selecciona una planta ðŸŒ±","error");
        return;
    }

    if(cantidadInput===""){
        mostrarMensaje("Ingresa la cantidad a reabastecer ðŸ“¦","error");
        return;
    }

    let cantidad=parseInt(cantidadInput);

    if(isNaN(cantidad)||cantidad<=0){
        mostrarMensaje("Cantidad invÃ¡lida ðŸ“¦","error");
        return;
    }

    plantas[nombre].inventario+=cantidad;

    guardar();
    mostrarInventario();

    cantidadReabastecer.value="";

    mostrarMensaje("Stock actualizado correctamente ðŸ“¦","exito");
}

// ===== REGISTRAR VENTA =====
descuentoCheck.addEventListener("change",()=>{
    descuentoDiv.classList.toggle("hidden");
});

function registrarVenta(){

    let nombre=ventaNombre.value;
    let cantidadInput=ventaCantidad.value;

    if(nombre===""){
        mostrarMensaje("Selecciona una planta ðŸŒ¿","error");
        return;
    }

    if(cantidadInput===""){
        mostrarMensaje("Ingresa la cantidad a vender ðŸ’°","error");
        return;
    }

    let cantidad=parseInt(cantidadInput);

    if(isNaN(cantidad)||cantidad<=0){
        mostrarMensaje("Cantidad invÃ¡lida ðŸ’°","error");
        return;
    }

    if(plantas[nombre].inventario<cantidad){
        mostrarMensaje("Inventario insuficiente","error");
        return;
    }

    let precio=plantas[nombre].precio;

    if(descuentoCheck.checked){
        if(claveAdminDescuento.value!==claveAdmin){
            mostrarMensaje("Clave incorrecta ðŸ”","error");
            return;
        }
        let nuevo=parseFloat(precioEspecial.value);
        if(isNaN(nuevo)||nuevo<=0){
            mostrarMensaje("Nuevo precio invÃ¡lido ðŸ’²","error");
            return;
        }
        precio=nuevo;
    }

    plantas[nombre].inventario-=cantidad;
    plantas[nombre].vendidas+=cantidad;

    ventas.push({
        nombre,
        cantidad,
        precio,
        total:cantidad*precio,
        fecha:new Date().toLocaleString(),
        usuario:usuarioActual
    });

    guardar();
    actualizarResumen();
    mostrarInventario();

    ventaCantidad.value="";
    precioEspecial.value="";
    claveAdminDescuento.value="";
    descuentoCheck.checked=false;
    descuentoDiv.classList.add("hidden");

    mostrarMensaje("Venta registrada correctamente ðŸ’°","exito");
}

// ===== INVENTARIO ORDENADO =====
function mostrarInventario(){

    inventario.innerHTML="";
    let nombres=obtenerNombresOrdenados();

    nombres.forEach(nombre=>{
        let p=plantas[nombre];
        let alerta=p.inventario<=10?"<span class='alerta'>âš  Bajo stock</span>":"";
        inventario.innerHTML+=`
        <p><strong>${nombre}</strong><br>
        Precio: $${p.precio}<br>
        Inventario: ${p.inventario} ${alerta}<br>
        Vendidas: ${p.vendidas}</p><hr>
        `;
    });
}

// ===== RESUMEN =====
function actualizarResumen(){
    let hoy=new Date().toLocaleDateString();
    let ventasHoy=ventas.filter(v=>new Date(v.fecha).toLocaleDateString()===hoy);
    let total=ventasHoy.reduce((s,v)=>s+v.total,0);
    let cantidad=ventasHoy.reduce((s,v)=>s+v.cantidad,0);
    resumen.innerHTML=`Vendidas hoy: ${cantidad}<br>Total hoy: $${total.toFixed(2)}`;
}

// ===== GRAFICAS =====
let chart1,chart2;

function generarGraficas(){

    let hoy=new Date().toLocaleDateString();
    let ventasHoy=ventas.filter(v=>new Date(v.fecha).toLocaleDateString()===hoy);
    let total=ventasHoy.reduce((s,v)=>s+v.total,0);

    if(chart1) chart1.destroy();
    if(chart2) chart2.destroy();

    chart1=new Chart(graficaDia,{
        type:"bar",
        data:{labels:["Hoy"],datasets:[{data:[total],backgroundColor:"#d4af37"}]}
    });

    let resumenPlantas={};
    ventasHoy.forEach(v=>{
        resumenPlantas[v.nombre]=(resumenPlantas[v.nombre]||0)+v.total;
    });

    chart2=new Chart(graficaPlantas,{
        type:"pie",
        data:{labels:Object.keys(resumenPlantas).sort(),
              datasets:[{data:Object.keys(resumenPlantas).sort().map(n=>resumenPlantas[n])}]}
    });
}

</script>
</body>
</html>
